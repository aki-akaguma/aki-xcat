# Development Tasks for aki-xcat

This document lists the development tasks based on the design document. All tasks are marked as implemented (`[x]`) as this reflects the current state of the source code.

### 1. Architecture & Setup

- [x] Set up the Rust workspace with a library crate (`libaki-xcat`) and a binary crate (`aki-xcat`).

### 2. Binary Crate (`aki-xcat`)

- [x] Implement the `main.rs` entry point.
- [x] Handle the collection of command-line arguments from the environment.
- [x] Initialize I/O streams for stdin, stdout, and stderr using the `runnel` crate.
- [x] Call the `libaki-xcat::execute` function to run the core application logic.
- [x] Implement top-level error handling to print messages to stderr and set the correct process exit code.

### 3. Library Crate (`libaki-xcat`)

#### 3.1. `lib.rs` (Library Facade)

- [x] Create the public `execute` function which serves as the main API for the library.
- [x] Orchestrate the application flow by calling the configuration parser and then the main run function.

#### 3.2. `conf` Module (Configuration)

- [x] Implement the `CmdOptConf` struct to store all parsed command-line options.
- [x] Use the `flood-tide` crate to define and parse all command-line arguments and options.
- [x] Implement parsing for `-H`/`--help` and `-V`/`--version` options.
- [x] Implement parsing for formatting options: `-b`/`--bin`, `-n`/`--number`, `-f`/`--file-name`, and `--path-name`.

#### 3.3. `run` Module (Core Logic)

- [x] Implement the main `run` function that receives the configuration and manages the processing flow.
- [x] Implement the `process_input` function to act as a dispatcher to the correct processing logic based on the configuration.
- [x] Implement `process_binary` to handle raw data transfer for binary mode.
- [x] Implement `process_text_simple` for efficient, un-decorated text output.
- [x] Implement `process_text_decorated` to handle the logic for prepending line numbers and/or file/path names.

#### 3.4. `util` Module (Utilities)

- [x] **`file_type`**: Implement the `detect_file_type` function to identify file formats by reading their magic numbers.
- [x] **`file_type`**: Add support for `gzip`, `xz`, `zstd`, `lz4`, `bzip2`, and `plain` formats.
- [x] **`adapt_input`**: Implement the `adapt_input` function to manage various input sources.
- [x] **`adapt_input`**: Handle multiple file paths, standard input (`-`), and the case with no input arguments.
- [x] **`adapt_input`**: Dynamically create the appropriate decompression reader and provide it as a `Box<dyn BufRead>` trait object.

### 4. Error Handling

- [x] Use `anyhow::Result` as the standard for error propagation throughout the application.
- [x] Implement the `util::err::BrokenPipeError` trait and use it to ensure the application exits silently on broken pipe errors.
- [x] Ensure clear error messages are provided for file-not-found, read, and decompression errors.
- [x] Handle invalid command-line options by printing a message to stderr and exiting.